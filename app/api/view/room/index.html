<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="__API__/js/jquery.min.js"></script>
</head>
<body>
<div id="welcome"></div>
<div>
    <input type="text" id="input"/>
    <input type="button" onclick="send()" value="发送"/>
</div>
<div id="message"></div>
<script>
    let socket,
        lockReconnect = false; //避免重复连接

    function getwebsocket() { //新建websocket的函数 页面初始化 断开连接时重新调用
        var wsUrl = 'wss://apptest.huihuagongxue.top:9502?token=test-token';
        socket = new WebSocket(wsUrl);
        socket.onerror = function(event) {
            reconnect(wsUrl);
        };
        socket.onclose = function(event) {
            reconnect(wsUrl);
        };
        socket.onopen = function(event) {
            heartCheck.reset().start(); //传递信息
        };
        socket.onmessage = function(event) {
            doWithMsg(event.data);
            heartCheck.reset().start();
        };
        //收到消息推送
        function doWithMsg(msg) {
            $("#message").append(
                "<h3>" + msg.data + "</h3>"
            );
        }
    }

    function reconnect(url) {
        if (lockReconnect) return;
        lockReconnect = true;
        //没连接上会一直重连，设置延迟避免请求过多
        setTimeout(function() {
            getwebsocket();
            lockReconnect = false;
        }, 2000);
    }
    //心跳检测
    var heartCheck = {
        timeout: 60000, //60秒
        timeoutObj: null,
        serverTimeoutObj: null,
        reset: function() {
            clearTimeout(this.timeoutObj);
            clearTimeout(this.serverTimeoutObj);
            return this;
        },
        start: function() {
            var self = this;
            this.timeoutObj = setTimeout(function() {
                //这里发送一个心跳，后端收到后，返回一个心跳消息，
                //onmessage拿到返回的心跳就说明连接正常
                socket.send("心跳测试");
                self.serverTimeoutObj = setTimeout(function() { //如果超过一定时间还没重置，说明后端主动断开了
                    socket.close(); //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次
                }, self.timeout)
            }, this.timeout)
        }
    }

    function send() {
        socket.send(JSON.stringify($("#input").val()));
    }
</script>
</body>
</html>