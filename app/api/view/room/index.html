<!DOCTYPE html>
<html lang="en">
<head>
    {include file="public/_meta" /}
</head>
<body class="layui-card">
<div id="welcome"></div>
<div>
    <input type="text" id="input"/>
    <input type="button" onclick="send()" value="发送"/>
</div>
<div id="message"></div>
<script>
    isApiLogin();
    let param = getParams(),
        uid = param.uid,
        wsServer = 'wss://apptest.huihuagongxue.top:9502?type=chat_uid_' + uid + '&token=' + getApiToken(),
        websocket = null,
        lock = false;
    $(document).ready(function (){
        link();
    });
    function link(){
        websocket = new WebSocket(wsServer);

        websocket.onopen = function (res) {

        };

        websocket.onclose = function (res) {
            websocket.close();
            relink();
        };

        websocket.onmessage = function (res) {
            $("#message").append(
                "<h3>" + res.data + "</h3>"
            );
        };

        websocket.onerror = function (res, e) {
            websocket.close();
            relink();
        };
    }

    function send() {
        let data = {
            'type' : 'chat',
            'message' : $("#input").val(),
            'uid' : uid
        };
        websocket.send(JSON.stringify(data));
    }

    function relink(){
        if (lock){
            return false;
        }
        lock = true;
        setTimeout(function (){
            link();
            lock = false;
        }, 1000);
    }
</script>
</body>
</html>